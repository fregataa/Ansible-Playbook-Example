# Prometheus Configuration
# Generated by Ansible - Do not edit manually

global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
  external_labels:
    cluster: {{ cluster_name }}

# Alertmanager 설정
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - localhost:{{ alertmanager_port }}

# 알람 룰 파일
rule_files:
  - "{{ prometheus_config_dir }}/rules/*.yml"

# 스크래핑 대상
scrape_configs:
  # Prometheus 자체 메트릭
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:{{ prometheus_port }}']
        labels:
          instance: 'prometheus'

  # Alertmanager 메트릭
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['localhost:{{ alertmanager_port }}']
        labels:
          instance: 'alertmanager'

  # Control Node - Node Exporter
  - job_name: 'node_exporter_control'
    static_configs:
{% for host in groups['control'] %}
      - targets: ['{{ hostvars[host]['ansible_host'] }}:{{ node_exporter_port }}']
        labels:
          instance: '{{ host }}'
          node_type: 'control'
{% endfor %}

  # GPU Nodes - Node Exporter
  - job_name: 'node_exporter_gpu'
    static_configs:
{% for host in groups['gpu_nodes'] %}
      - targets: ['{{ hostvars[host]['ansible_host'] }}:{{ node_exporter_port }}']
        labels:
          instance: '{{ host }}'
          node_type: 'gpu'
{% if hostvars[host]['gpu_type'] is defined %}
          gpu_type: '{{ hostvars[host]['gpu_type'] }}'
{% endif %}
{% if hostvars[host]['gpu_count'] is defined %}
          gpu_count: '{{ hostvars[host]['gpu_count'] }}'
{% endif %}
{% endfor %}

  # GPU Nodes - DCGM Exporter
  - job_name: 'dcgm_exporter'
    static_configs:
{% for host in groups['gpu_nodes'] %}
      - targets: ['{{ hostvars[host]['ansible_host'] }}:{{ dcgm_exporter_port }}']
        labels:
          instance: '{{ host }}'
{% if hostvars[host]['gpu_type'] is defined %}
          gpu_type: '{{ hostvars[host]['gpu_type'] }}'
{% endif %}
{% if hostvars[host]['gpu_count'] is defined %}
          gpu_count: '{{ hostvars[host]['gpu_count'] }}'
{% endif %}
{% endfor %}

  # Grafana 메트릭 (선택)
  - job_name: 'grafana'
    static_configs:
      - targets: ['localhost:{{ grafana_port }}']
        labels:
          instance: 'grafana'
