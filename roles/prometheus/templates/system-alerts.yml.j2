# System Alert Rules
# Generated by Ansible - Do not edit manually

groups:
  - name: node_alerts
    rules:
      # 노드 다운
      - alert: NodeDown
        expr: up{job=~"node_exporter.*"} == 0
        for: {{ alert_node_down_duration }}
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Node {{ '{{ $labels.instance }}' }} is down"
          description: "Node {{ '{{ $labels.instance }}' }} has been unreachable for {{ alert_node_down_duration }}."

      # DCGM Exporter 다운
      - alert: DCGMExporterDown
        expr: up{job="dcgm_exporter"} == 0
        for: 2m
        labels:
          severity: critical
          category: gpu
        annotations:
          summary: "DCGM Exporter down on {{ '{{ $labels.instance }}' }}"
          description: "DCGM Exporter on {{ '{{ $labels.instance }}' }} is not responding. GPU metrics are not being collected."

      # CPU 사용률 높음
      - alert: HighCPUUsage
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 15m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High CPU usage on {{ '{{ $labels.instance }}' }}"
          description: "CPU usage is above 90% on {{ '{{ $labels.instance }}' }} for 15 minutes."

      # 메모리 사용률 높음
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 15m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High memory usage on {{ '{{ $labels.instance }}' }}"
          description: "Memory usage is above 90% on {{ '{{ $labels.instance }}' }}."

      # 디스크 사용률 높음
      - alert: HighDiskUsage
        expr: |
          (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"})) * 100 > 85
        for: 30m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High disk usage on {{ '{{ $labels.instance }}' }}"
          description: "Disk {{ '{{ $labels.mountpoint }}' }} on {{ '{{ $labels.instance }}' }} is {{ '{{ $value | printf \"%.1f\" }}' }}% full."

      # 디스크 거의 가득 참
      - alert: DiskAlmostFull
        expr: |
          (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"})) * 100 > 95
        for: 10m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Disk almost full on {{ '{{ $labels.instance }}' }}"
          description: "Disk {{ '{{ $labels.mountpoint }}' }} on {{ '{{ $labels.instance }}' }} is {{ '{{ $value | printf \"%.1f\" }}' }}% full. Immediate action required!"

      # 시스템 로드 높음
      - alert: HighSystemLoad
        expr: node_load15 / count without (cpu) (node_cpu_seconds_total{mode="idle"}) > 2
        for: 30m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High system load on {{ '{{ $labels.instance }}' }}"
          description: "15-minute load average is {{ '{{ $value | printf \"%.2f\" }}' }} on {{ '{{ $labels.instance }}' }}."

      # 네트워크 수신 에러
      - alert: NetworkReceiveErrors
        expr: rate(node_network_receive_errs_total[5m]) > 0
        for: 10m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Network receive errors on {{ '{{ $labels.instance }}' }}"
          description: "Interface {{ '{{ $labels.device }}' }} on {{ '{{ $labels.instance }}' }} has receive errors."

      # 네트워크 전송 에러
      - alert: NetworkTransmitErrors
        expr: rate(node_network_transmit_errs_total[5m]) > 0
        for: 10m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Network transmit errors on {{ '{{ $labels.instance }}' }}"
          description: "Interface {{ '{{ $labels.device }}' }} on {{ '{{ $labels.instance }}' }} has transmit errors."

  - name: prometheus_alerts
    rules:
      # Prometheus 설정 리로드 실패
      - alert: PrometheusConfigReloadFailed
        expr: prometheus_config_last_reload_successful == 0
        for: 5m
        labels:
          severity: warning
          category: monitoring
        annotations:
          summary: "Prometheus config reload failed"
          description: "Prometheus failed to reload its configuration. Check prometheus logs."

      # 스크래핑 타겟 다운
      - alert: PrometheusTargetMissing
        expr: up == 0
        for: 5m
        labels:
          severity: warning
          category: monitoring
        annotations:
          summary: "Prometheus target missing: {{ '{{ $labels.job }}' }}"
          description: "Target {{ '{{ $labels.instance }}' }} in job {{ '{{ $labels.job }}' }} is down."

      # Alertmanager 연결 실패
      - alert: AlertmanagerNotConnected
        expr: prometheus_notifications_alertmanagers_discovered < 1
        for: 5m
        labels:
          severity: critical
          category: monitoring
        annotations:
          summary: "Alertmanager not discovered"
          description: "Prometheus cannot find any Alertmanager instance. Alerts will not be sent!"
