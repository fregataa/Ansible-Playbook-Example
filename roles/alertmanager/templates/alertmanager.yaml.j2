# Alertmanager Configuration
# Generated by Ansible - Do not edit manually

global:
  resolve_timeout: 5m
{% if alertmanager_smtp_host is defined and alertmanager_smtp_host %}
  smtp_smarthost: '{{ alertmanager_smtp_host }}:{{ alertmanager_smtp_port | default(587) }}'
  smtp_from: '{{ alertmanager_smtp_from }}'
{% if alertmanager_smtp_auth_username is defined %}
  smtp_auth_username: '{{ alertmanager_smtp_auth_username }}'
  smtp_auth_password: '{{ alertmanager_smtp_auth_password }}'
{% endif %}
  smtp_require_tls: true
{% endif %}
{% if alertmanager_slack_webhook is defined and alertmanager_slack_webhook %}
  slack_api_url: '{{ alertmanager_slack_webhook }}'
{% endif %}

# 알림 템플릿
templates:
  - '{{ alertmanager_config_dir }}/templates/*.tmpl'

# 라우팅 설정
route:
  # 기본 수신자
  receiver: 'default-receiver'

  # 알람 그룹핑 기준
  group_by: ['alertname', 'severity', 'instance']

  # 그룹 대기 시간 (같은 그룹 알람 묶음)
  group_wait: {{ alertmanager_group_wait }}

  # 그룹 전송 간격
  group_interval: {{ alertmanager_group_interval }}

  # 동일 알람 반복 전송 간격
  repeat_interval: {{ alertmanager_repeat_interval }}

  # 하위 라우트
  routes:
    # Critical 알람은 즉시 전송
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # GPU 관련 알람
    - match:
        category: gpu
      receiver: 'gpu-receiver'
      continue: true

    # Warning 알람
    - match:
        severity: warning
      receiver: 'warning-receiver'
      continue: true

    # Info 알람 (선택적)
    - match:
        severity: info
      receiver: 'info-receiver'

# 수신자 정의
receivers:
  - name: 'default-receiver'
{% if alertmanager_slack_webhook is defined and alertmanager_slack_webhook %}
    slack_configs:
      - channel: '{{ alertmanager_slack_channel | default("#alerts") }}'
        send_resolved: true
        title: '{{ "{{ template \"slack.title\" . }}" }}'
        text: '{{ "{{ template \"slack.text\" . }}" }}'
        color: '{{ "{{ template \"slack.color\" . }}" }}'
{% endif %}
{% if alertmanager_email_to is defined and alertmanager_email_to %}
    email_configs:
      - to: '{{ alertmanager_email_to }}'
        send_resolved: true
        html: '{{ "{{ template \"email.html\" . }}" }}'
{% endif %}
{% if alertmanager_webhook_url is defined and alertmanager_webhook_url %}
    webhook_configs:
      - url: '{{ alertmanager_webhook_url }}'
        send_resolved: true
{% endif %}

  - name: 'critical-receiver'
{% if alertmanager_slack_webhook is defined and alertmanager_slack_webhook %}
    slack_configs:
      - channel: '{{ alertmanager_slack_channel | default("#alerts") }}'
        send_resolved: true
        title: '{{ "{{ template \"slack.title\" . }}" }}'
        text: '{{ "{{ template \"slack.text\" . }}" }}'
        color: '{{ "{{ template \"slack.color\" . }}" }}'
{% endif %}
{% if alertmanager_email_to is defined and alertmanager_email_to %}
    email_configs:
      - to: '{{ alertmanager_email_to }}'
        send_resolved: true
        headers:
          Subject: '[CRITICAL] {{ "{{ .GroupLabels.alertname }}" }}'
{% endif %}

  - name: 'gpu-receiver'
{% if alertmanager_slack_webhook is defined and alertmanager_slack_webhook %}
    slack_configs:
      - channel: '{{ alertmanager_slack_channel | default("#gpu-alerts") }}'
        send_resolved: true
        title: '{{ "{{ template \"slack.gpu.title\" . }}" }}'
        text: '{{ "{{ template \"slack.gpu.text\" . }}" }}'
        color: '{{ "{{ template \"slack.color\" . }}" }}'
{% endif %}

  - name: 'warning-receiver'
{% if alertmanager_slack_webhook is defined and alertmanager_slack_webhook %}
    slack_configs:
      - channel: '{{ alertmanager_slack_channel | default("#alerts") }}'
        send_resolved: true
        title: '{{ "{{ template \"slack.title\" . }}" }}'
        text: '{{ "{{ template \"slack.text\" . }}" }}'
        color: '{{ "{{ template \"slack.color\" . }}" }}'
{% endif %}

  - name: 'info-receiver'
    # Info 레벨은 기본적으로 무시 (필요시 설정 추가)

# 알람 억제 규칙
inhibit_rules:
  # Critical이 발생하면 동일 인스턴스의 Warning 억제
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  # NodeDown이면 해당 노드의 다른 알람 억제
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: '.+'
    equal: ['instance']

  # DCGMExporterDown이면 GPU 알람 억제
  - source_match:
      alertname: 'DCGMExporterDown'
    target_match:
      category: 'gpu'
    equal: ['instance']
