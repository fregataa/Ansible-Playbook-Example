# GPU Alert Rules
# Generated by Ansible - Do not edit manually

groups:
  - name: gpu_alerts
    rules:
      # GPU 온도 경고 (Warning)
      - alert: GPUTemperatureWarning
        expr: DCGM_FI_DEV_GPU_TEMP > {{ alert_gpu_temp_warning }}
        for: 5m
        labels:
          severity: warning
          category: gpu
        annotations:
          summary: "GPU temperature warning on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} has temperature {{ '{{ $value | printf \"%.1f\" }}' }}°C (threshold: {{ alert_gpu_temp_warning }}°C)"

      # GPU 온도 위험 (Critical)
      - alert: GPUTemperatureCritical
        expr: DCGM_FI_DEV_GPU_TEMP > {{ alert_gpu_temp_critical }}
        for: 2m
        labels:
          severity: critical
          category: gpu
        annotations:
          summary: "GPU temperature critical on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} has temperature {{ '{{ $value | printf \"%.1f\" }}' }}°C (threshold: {{ alert_gpu_temp_critical }}°C). Immediate action required!"

      # GPU 메모리 사용률 높음
      - alert: GPUMemoryHigh
        expr: |
          (DCGM_FI_DEV_FB_USED / (DCGM_FI_DEV_FB_USED + DCGM_FI_DEV_FB_FREE)) * 100 > {{ alert_gpu_memory_warning }}
        for: 10m
        labels:
          severity: warning
          category: gpu
        annotations:
          summary: "GPU memory usage high on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} memory usage is {{ '{{ $value | printf \"%.1f\" }}' }}%"

      # GPU 메모리 누수 의심 (메모리 높음 + 사용률 낮음)
      - alert: GPUMemoryLeakSuspected
        expr: |
          (DCGM_FI_DEV_FB_USED / (DCGM_FI_DEV_FB_USED + DCGM_FI_DEV_FB_FREE)) * 100 > {{ alert_gpu_memory_critical }}
          and
          DCGM_FI_DEV_GPU_UTIL < {{ alert_gpu_idle_threshold }}
        for: 30m
        labels:
          severity: warning
          category: gpu
        annotations:
          summary: "Possible GPU memory leak on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} has high memory usage but low utilization. Possible memory leak."

      # ECC 에러 임계치 초과
      - alert: GPUECCErrors
        expr: |
          increase(DCGM_FI_DEV_ECC_SBE_VOL_TOTAL[24h]) > {{ alert_ecc_error_threshold }}
          or
          increase(DCGM_FI_DEV_ECC_DBE_VOL_TOTAL[24h]) > 0
        for: 5m
        labels:
          severity: critical
          category: gpu
        annotations:
          summary: "GPU ECC errors detected on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} has excessive ECC errors in the last 24 hours. Consider GPU replacement."

      # XID 에러 발생
      - alert: GPUXidError
        expr: DCGM_FI_DEV_XID_ERRORS > 0
        for: 1m
        labels:
          severity: critical
          category: gpu
        annotations:
          summary: "GPU XID error on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} reported XID error code {{ '{{ $value }}' }}. Check dmesg for details."

      # GPU 유휴 상태 (낭비 감지)
      - alert: GPUIdle
        expr: DCGM_FI_DEV_GPU_UTIL == 0
        for: {{ alert_gpu_idle_duration }}
        labels:
          severity: info
          category: gpu
        annotations:
          summary: "GPU idle on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} has been idle for {{ alert_gpu_idle_duration }}."

      # NVLink 에러
      - alert: GPUNVLinkErrors
        expr: increase(DCGM_FI_DEV_GPU_NVLINK_ERRORS[1h]) > 0
        for: 5m
        labels:
          severity: warning
          category: gpu
        annotations:
          summary: "NVLink errors on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} has NVLink errors."

      # 전력 제한 (Power Throttling)
      - alert: GPUPowerThrottling
        expr: increase(DCGM_FI_DEV_POWER_VIOLATION[1h]) > 10
        for: 10m
        labels:
          severity: warning
          category: gpu
        annotations:
          summary: "GPU power throttling on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} is experiencing power throttling."

      # 열 제한 (Thermal Throttling)
      - alert: GPUThermalThrottling
        expr: increase(DCGM_FI_DEV_THERMAL_VIOLATION[1h]) > 10
        for: 10m
        labels:
          severity: warning
          category: gpu
        annotations:
          summary: "GPU thermal throttling on {{ '{{ $labels.instance }}' }}"
          description: "GPU {{ '{{ $labels.gpu }}' }} on {{ '{{ $labels.instance }}' }} is experiencing thermal throttling."
